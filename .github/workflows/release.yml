name: Create Release

on:
  push:
    branches:
      - 'main'        # Trigger when pushing to main branch
      - 'master'      # Also trigger when pushing to master branch
    tags:
      - 'v*'          # Also trigger when pushing tags

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper tag handling

      - name: Extract version from CHANGELOG.md
        id: extract-version
        run: |
          # Extract the first version from CHANGELOG.md
          VERSION=$(grep -m 1 "^\## \[.*\].*" CHANGELOG.md | head -1 | sed -E 's/^\## \[(.*)\].*/\1/')

          if [[ -z "$VERSION" ]]; then
            echo "ERROR: Could not find version in CHANGELOG.md"
            exit 1
          fi

          # Validate version format (X.Y.Z)
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
            echo "ERROR: Invalid version format found in CHANGELOG.md: $VERSION"
            exit 1
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Found version: ${VERSION} from CHANGELOG.md"

      - name: Get previous tag
        id: prev-tag
        run: |
          # Get the previous tag for changelog comparison
          PREV_TAG=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | sed -n 2p)
          if [ -z "$PREV_TAG" ]; then
            PREV_TAG=$(git tag --sort=-v:refname | head -n1)
          fi

          if [ -z "$PREV_TAG" ]; then
            echo "previous_tag=0.0.0" >> $GITHUB_OUTPUT
          else
            echo "previous_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          fi
          echo "Previous tag: $PREV_TAG"

      - name: Verify changelog has entries for version
        run: |
          VERSION="${{ steps.extract-version.outputs.version }}"
          if ! grep -q "\[${VERSION}\]" CHANGELOG.md; then
            echo "ERROR: Version ${VERSION} not found in CHANGELOG.md"
            exit 1
          fi

      - name: Configure git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Create or update tag
        run: |
          VERSION="v${{ steps.extract-version.outputs.version }}"

          # Check if tag already exists
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Tag $VERSION already exists, skipping tag creation"
          else
            echo "Creating new tag: $VERSION"
            git tag -a "${VERSION}" -m "Release version ${VERSION}"
            git push origin "${VERSION}"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.extract-version.outputs.version }}
          name: Release v${{ steps.extract-version.outputs.version }}
          body: |
            ## v${{ steps.extract-version.outputs.version }}

            See the [CHANGELOG](CHANGELOG.md#v${{ steps.extract-version.outputs.version }}) for details on this release.

            ### What's Changed
            * Automated release from release branch

            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.prev-tag.outputs.previous_tag }}...v${{ steps.extract-version.outputs.version }}
          draft: false
          prerelease: false